<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimorio Manager V0.14 - Limits</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- VARIABILI CSS (Light/Dark) --- */
        :root {
            --bg-color: #fdf6e3;
            --bg-image: url("https://www.transparenttextures.com/patterns/aged-paper.png");
            --card-bg: #fffbf0;
            --text-color: #2c1a0b;
            --primary-color: #8b0000;
            --secondary-color: #555;
            --border-color: #d2b48c;
            --accent-color: #d4af37; /* Oro per Classe 1 */
            --class2-color: #3498db; /* Blu per Classe 2 */
            --free-color: #27ae60;   /* Verde per Free */
            --warning-color: #c0392b; /* Rosso per Over Limit */
            --hover-bg: rgba(210, 180, 140, 0.2);
            --input-bg: #ffffff;
            --input-text: #2c1a0b;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --bg-image: linear-gradient(to bottom, #121212, #1a1a1a);
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #ff4d4d;
            --secondary-color: #a0a0a0;
            --border-color: #333;
            --accent-color: #ffd700;
            --class2-color: #2980b9;
            --free-color: #2ecc71;
            --warning-color: #e74c3c;
            --hover-bg: rgba(255, 255, 255, 0.05);
            --input-bg: #2a2a2a;
            --input-text: #e0e0e0;
            --shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            color: var(--text-color);
            margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; min-height: 100vh;
        }

        /* --- UI COMPONENTS --- */
        h1 { font-family: 'Cinzel', serif; color: var(--primary-color); text-align: center; margin: 5px 0; }
        .subtitle { text-align: center; color: var(--secondary-color); font-size: 0.9em; margin-bottom: 20px; }

        .theme-switch {
            position: absolute; top: 20px; right: 20px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 8px 12px; border-radius: 20px;
            cursor: pointer; box-shadow: var(--shadow);
        }

        /* --- CHARACTER SELECTOR --- */
        .char-manager {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 15px; max-width: 1000px; margin: 0 auto 20px auto;
            box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .char-main { display: flex; gap: 15px; align-items: center; flex-grow: 1; min-width: 250px; }
        .char-info { flex-grow: 1; }
        .char-label { font-size:0.75em; color:var(--secondary-color); text-transform: uppercase; letter-spacing: 1px;}
        .select-group { display: flex; align-items: center; gap: 5px; }
        select.char-select {
            font-family: 'Cinzel', serif; font-size: 1.2em; color: var(--primary-color);
            font-weight: bold; border: none; border-bottom: 2px solid var(--primary-color);
            background: transparent; padding: 5px 0; cursor: pointer; width: auto; min-width: 100px;
        }
        select.char-select:focus { outline: none; }
        .btn-mini {
            background: var(--card-bg); border: 1px solid var(--border-color);
            color: var(--secondary-color); padding: 6px 10px; border-radius: 4px;
            cursor: pointer; font-size: 0.9em; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-mini:hover { background: var(--hover-bg); color: var(--primary-color); border-color: var(--primary-color); }
        .btn-danger:hover { color: #d32f2f; border-color: #d32f2f; background: rgba(211, 47, 47, 0.1); }
        .char-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* --- TABS --- */
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .tab-btn {
            background: none; border: none; padding: 15px 20px;
            font-family: 'Cinzel', serif; font-size: 1.1em; cursor: pointer;
            color: var(--secondary-color); border-bottom: 4px solid transparent;
            transition: all 0.3s; white-space: nowrap;
        }
        .tab-btn:hover { color: var(--primary-color); background-color: var(--hover-bg); }
        .tab-btn.active { color: var(--primary-color); border-bottom: 4px solid var(--primary-color); font-weight: bold; }
        
        .tab-btn.class1-tab.active { color: #b8860b; border-color: var(--accent-color); }
        .tab-btn.class2-tab.active { color: var(--class2-color); border-color: var(--class2-color); }

        .tab-count {
            background-color: var(--primary-color); color: #fff; border-radius: 50%; padding: 2px 6px;
            font-size: 0.7em; vertical-align: middle; margin-left: 5px; font-family: 'Lato', sans-serif; min-width: 15px; display: inline-block; text-align: center;
        }
        
        /* Warning Badge Style */
        .tab-count.warning { background-color: var(--warning-color); animation: pulse-badge 2s infinite; }
        @keyframes pulse-badge { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- SECTIONS --- */
        .section-view { display: none; max-width: 1000px; margin: 0 auto; }
        .section-view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .controls {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        input, select {
            width: 100%; padding: 8px; border: 1px solid var(--border-color);
            border-radius: 4px; background: var(--input-bg); color: var(--input-text);
            font-family: 'Lato', sans-serif; box-sizing: border-box;
        }
        .file-upload-mini { text-align: right; font-size: 0.8em; margin-bottom: 10px; color: var(--secondary-color); }
        .link-btn { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; }

        /* --- SPELL CARD --- */
        .spell-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 5px; margin-bottom: 10px; overflow: hidden;
            box-shadow: var(--shadow); transition: all 0.2s; position: relative;
        }
        .spell-header { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .spell-header:hover { background: var(--hover-bg); }
        
        .prep-check-group { display: flex; gap: 8px; margin-right: 15px; z-index: 10; align-items: center; }
        .prep-checkbox {
            appearance: none; width: 22px; height: 22px;
            border: 2px solid var(--border-color); border-radius: 4px;
            background: var(--input-bg); cursor: pointer; position: relative; transition: all 0.2s;
        }
        .prep-checkbox.class1:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .prep-checkbox.class2:checked { background-color: var(--class2-color); border-color: var(--class2-color); }
        
        .free-label { font-size: 0.75em; font-weight: bold; color: var(--free-color); margin-left: 5px; cursor: pointer; display: flex; align-items: center; gap: 3px; }
        .prep-checkbox.free-check { width: 18px; height: 18px; border-color: var(--free-color); }
        .prep-checkbox.free-check:checked { background-color: var(--free-color); }

        .prep-checkbox:checked::after {
            content: '\f00c'; font-family: 'Font Awesome 5 Free'; font-weight: 900;
            color: #fff; font-size: 12px; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .spell-card.is-prepared-1 { border-left: 5px solid var(--accent-color); }
        .spell-card.is-prepared-2 { border-right: 5px solid var(--class2-color); }
        .spell-card.is-free { border-top: 3px solid var(--free-color); } 

        .spell-title { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.05em; color: var(--primary-color); }
        .spell-meta-short { font-size: 0.85em; color: var(--secondary-color); }
        .spell-details { display: none; padding: 15px; border-top: 1px solid var(--border-color); background-color: var(--card-bg); }
        .spell-card.active .spell-details { display: block; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;
            margin-bottom: 12px; font-size: 0.85em; padding: 8px;
            border-radius: 4px; border: 1px solid var(--border-color);
        }
        .stat-box strong { display: block; color: var(--primary-color); font-size: 0.8em; text-transform: uppercase; }
        .spell-desc { line-height: 1.6; font-size: 0.95em; margin-bottom: 10px; white-space: pre-line; }
        .higher-levels { background-color: rgba(255,0,0,0.05); padding: 8px; border-left: 3px solid var(--primary-color); margin-top: 8px; font-style: italic; }
        
        .icon-tag { font-size: 0.8em; padding: 1px 4px; border-radius: 3px; margin-left: 5px; vertical-align: middle;}
        .icon-conc { color: #fff; background-color: var(--primary-color); }
        [data-theme="dark"] .icon-conc { color: #000; background-color: var(--primary-color); }
        .icon-rit { border: 1px solid var(--text-color); }
        .icon-free { background-color: var(--free-color); color: white; font-weight: bold; }

        /* --- MAGIC SECTION --- */
        .hero-bar {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 15px; margin-bottom: 20px; box-shadow: var(--shadow);
            display: flex; gap: 15px; justify-content: space-around; flex-wrap: wrap;
        }
        .class-config-group { border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; text-align: center; flex: 1; min-width: 250px; }
        .class-name-input {
            width: 100%; border: none; border-bottom: 1px dashed var(--secondary-color);
            background: transparent; color: var(--primary-color); font-family: 'Cinzel', serif; 
            font-size: 1.1em; text-align: center; margin-bottom: 10px; font-weight: bold;
        }
        .stat-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .hero-stat-box { text-align: center; width: 80px; flex-grow: 1; }
        .hero-stat-box label { display: block; font-size: 0.7em; color: var(--secondary-color); margin-bottom: 3px; text-transform: uppercase; }
        .hero-stat-box input { 
            width: 100%; text-align: center; font-size: 1.2em; font-family: 'Cinzel', serif;
            color: var(--primary-color); font-weight: bold; background: transparent; border: 2px solid var(--border-color); padding: 5px;
        }

        .magic-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: start; }
        @media (max-width: 900px) { .magic-grid { grid-template-columns: 1fr; } }
        
        .magic-col-slots { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; box-shadow: var(--shadow); }
        .slot-row { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .slot-label { width: 90px; font-weight: bold; color: var(--secondary-color); font-family: 'Cinzel', serif; font-size: 0.9em; }
        .slot-config { margin-right: 15px; display: flex; align-items: center; gap: 5px; }
        .slot-config input { width: 45px; text-align: center; padding: 4px; font-size: 0.9em; }
        .slot-bubbles { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .slot-bubble {
            width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--primary-color); cursor: pointer; transition: 0.2s; background-color: var(--primary-color); box-shadow: 0 0 5px rgba(139, 0, 0, 0.4);
        }
        .slot-bubble.used { background-color: transparent; border-color: var(--secondary-color); box-shadow: none; }

        .magic-col-resources { display: flex; flex-direction: column; gap: 20px; height: 100%; }
        .resource-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; 
            padding: 25px; box-shadow: var(--shadow); flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .resource-title { font-family: 'Cinzel', serif; color: var(--primary-color); font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); width: 100%; text-align: center; padding-bottom: 5px; font-size: 1.1em; }
        .resource-display { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .res-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-weight: bold; font-size: 1.5em;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .res-btn:hover { background: var(--hover-bg); color: var(--primary-color); border-color: var(--primary-color); transform: scale(1.1); }
        .res-value { font-size: 3.5em; font-family: 'Cinzel', serif; color: var(--primary-color); font-weight: bold; min-width: 80px; text-align: center; }
        .resource-config { display: flex; align-items: center; gap: 5px; font-size: 0.9em; color: var(--secondary-color); }
        .resource-config input { width: 60px; text-align: center; font-weight: bold; font-size: 1em;}

        .long-rest-btn {
            display: block; width: 100%; margin: 20px auto 0; padding: 15px; background: var(--primary-color); color: #fff;
            border: none; border-radius: 5px; font-family: 'Cinzel', serif; font-size: 1.1em; cursor: pointer; transition: 0.3s;
        }
        .long-rest-btn:hover { background-color: #a00000; transform: scale(1.02); }

        /* WARNING STYLES */
        .over-limit-text { color: var(--warning-color) !important; font-weight: bold; animation: text-pulse 2s infinite; }
        @keyframes text-pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Utility */
        #file-input { display: none; }
        #json-import-input { display: none; }
    </style>
</head>
<body>

    <button class="theme-switch" onclick="toggleTheme()" title="Cambia Tema"><i class="fas fa-adjust"></i></button>

    <h1>Grimorio Arcano</h1>
    <div class="subtitle">D20 Revolution - Dual Class Manager</div>

    <div class="char-manager">
        <div class="char-main">
            <i class="fas fa-user-circle fa-2x" style="color: var(--primary-color);"></i>
            <div class="char-info">
                <div class="char-label">Personaggio Attivo</div>
                <div class="select-group">
                    <select id="char-select" class="char-select" onchange="changeCharacter()"></select>
                    <button class="btn-mini" onclick="renameCharacter()" title="Rinomina"><i class="fas fa-edit"></i></button>
                </div>
            </div>
        </div>
        <div class="char-actions">
            <input type="file" id="json-import-input" accept=".json" onchange="importCharacterFile(this)">
            <button class="btn-mini" onclick="createNewCharacter()" title="Nuovo PG"><i class="fas fa-plus"></i> Nuovo</button>
            <button class="btn-mini" onclick="document.getElementById('json-import-input').click()" title="Importa"><i class="fas fa-file-import"></i> Import</button>
            <button class="btn-mini" onclick="exportCharacter()" title="Salva"><i class="fas fa-file-export"></i> Export</button>
            <button class="btn-mini btn-danger" onclick="deleteCharacter()" title="Elimina"><i class="fas fa-trash"></i></button>
        </div>
    </div>

    <div class="controls">
        <div class="file-upload-mini">
            <span id="db-status">Stato DB: ...</span>
            <input type="file" id="file-input" accept=".csv">
            | <button class="link-btn" onclick="document.getElementById('file-input').click()">Aggiorna CSV Incantesimi</button>
        </div>
        
        <div id="filter-container" class="filters">
            <input type="text" id="search-input" placeholder="Cerca incantesimo...">
            <select id="class-select"><option value="all">Tutte le Classi</option></select>
            <select id="level-select">
                <option value="all">Tutti i Livelli</option>
                <option value="0">Trucchetto (0)</option>
                <option value="1">Livello 1</option>
                <option value="2">Livello 2</option>
                <option value="3">Livello 3</option>
                <option value="4">Livello 4</option>
                <option value="5">Livello 5</option>
                <option value="6">Livello 6</option>
                <option value="7">Livello 7</option>
                <option value="8">Livello 8</option>
                <option value="9">Livello 9</option>
                <option value="10">Livello 10</option>
            </select>
            <select id="school-select"><option value="all">Tutte le Scuole</option></select>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('grimorio')">
            <i class="fas fa-book"></i> Grimorio
        </button>
        
        <button class="tab-btn class1-tab" onclick="switchTab('class1')">
            <i class="fas fa-scroll"></i> <span id="tab-label-c1">Classe 1</span> 
            <span class="tab-count" id="badge-c1">0</span>
        </button>
        
        <button class="tab-btn class2-tab" onclick="switchTab('class2')">
            <i class="fas fa-scroll"></i> <span id="tab-label-c2">Classe 2</span>
            <span class="tab-count" id="badge-c2">0</span>
        </button>
        
        <button class="tab-btn" onclick="switchTab('magic')">
            <i class="fas fa-bolt"></i> Magic
        </button>
    </div>

    <div id="view-grimorio" class="section-view active">
        <div id="spell-container-grimorio"></div>
    </div>

    <div id="view-class1" class="section-view">
        <h2 style="color: var(--accent-color); border-bottom: 2px solid var(--accent-color); padding-bottom:10px;">
            <span id="title-c1">Classe 1</span> 
            <span id="limit-c1" style="font-size:0.8em; margin-left:10px; color:var(--text-color);">(0/0)</span>
        </h2>
        <div id="spell-container-c1"></div>
    </div>

    <div id="view-class2" class="section-view">
        <h2 style="color: var(--class2-color); border-bottom: 2px solid var(--class2-color); padding-bottom:10px;">
            <span id="title-c2">Classe 2</span>
            <span id="limit-c2" style="font-size:0.8em; margin-left:10px; color:var(--text-color);">(0/0)</span>
        </h2>
        <div id="spell-container-c2"></div>
    </div>

    <div id="view-magic" class="section-view">
        
        <div class="hero-bar">
            <div class="class-config-group" style="border-color: var(--accent-color);">
                <input type="text" class="class-name-input" id="class1-name" value="Classe 1" placeholder="Nome Classe 1" onchange="saveCurrentProfile()">
                <div class="stat-row">
                    <div class="hero-stat-box">
                        <label>CD Spell</label>
                        <input type="number" id="dc1" value="10" onchange="saveCurrentProfile()">
                    </div>
                    <div class="hero-stat-box">
                        <label>Atk Bonus</label>
                        <input type="number" id="atk1" value="0" onchange="saveCurrentProfile()">
                    </div>
                    <div class="hero-stat-box">
                        <label>Max Prep</label>
                        <input type="number" id="maxPrep1" value="0" min="0" onchange="saveCurrentProfile()">
                    </div>
                </div>
            </div>

            <div class="class-config-group" style="border-color: var(--class2-color);">
                <input type="text" class="class-name-input" id="class2-name" value="Classe 2" placeholder="Nome Classe 2" onchange="saveCurrentProfile()" style="color: var(--class2-color);">
                <div class="stat-row">
                    <div class="hero-stat-box">
                        <label>CD Spell</label>
                        <input type="number" id="dc2" value="10" onchange="saveCurrentProfile()">
                    </div>
                    <div class="hero-stat-box">
                        <label>Atk Bonus</label>
                        <input type="number" id="atk2" value="0" onchange="saveCurrentProfile()">
                    </div>
                    <div class="hero-stat-box">
                        <label>Max Prep</label>
                        <input type="number" id="maxPrep2" value="0" min="0" onchange="saveCurrentProfile()">
                    </div>
                </div>
            </div>
        </div>

        <div class="magic-grid">
            <div class="magic-col-slots">
                <h3 style="text-align:left; border-bottom:1px solid var(--border-color); padding-bottom:5px; margin-top:0;">Slot Incantesimo</h3>
                <div id="slots-container"></div>
            </div>
            <div class="magic-col-resources">
                <div class="resource-card">
                    <div class="resource-title">Mana Points</div>
                    <div class="resource-display">
                        <button class="res-btn" onclick="modifyResource('mana', -1)">-</button>
                        <span id="display-mana" class="res-value">0</span>
                        <button class="res-btn" onclick="modifyResource('mana', 1)">+</button>
                    </div>
                    <div class="resource-config">
                        Max: <input type="number" id="mana-max" value="0" min="0" onchange="updateResourceMax('mana', this.value)">
                    </div>
                </div>
                <div class="resource-card">
                    <div class="resource-title">Sorcery Points</div>
                    <div class="resource-display">
                        <button class="res-btn" onclick="modifyResource('sorcery', -1)">-</button>
                        <span id="display-sorcery" class="res-value">0</span>
                        <button class="res-btn" onclick="modifyResource('sorcery', 1)">+</button>
                    </div>
                    <div class="resource-config">
                        Max: <input type="number" id="sorcery-max" value="0" min="0" onchange="updateResourceMax('sorcery', this.value)">
                    </div>
                </div>
            </div>
        </div>
        <button class="long-rest-btn" onclick="longRest()"><i class="fas fa-bed"></i> Riposo Lungo (Reset All)</button>
    </div>

    <script>
        // --- GESTIONE DATI GLOBALI ---
        let spellData = [];
        let profiles = {}; 
        let currentCharName = "Default"; 
        let currentTab = 'grimorio';

        const defaultProfile = {
            class1Name: "Classe 1", class2Name: "Classe 2",
            prepared1: [], prepared2: [],
            free1: [], free2: [], 
            stats1: { dc: 10, atk: 0, maxPrep: 0 }, stats2: { dc: 10, atk: 0, maxPrep: 0 },
            resources: { mana: 0, sorcery: 0, manaUsed: 0, sorceryUsed: 0 },
            slots: {} 
        };
        for(let i=1; i<=10; i++) defaultProfile.slots[i] = { max: 0, usage: [] };

        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const dbStatus = document.getElementById('db-status');
        const charSelect = document.getElementById('char-select');
        
        const badgeC1 = document.getElementById('badge-c1');
        const badgeC2 = document.getElementById('badge-c2');
        const labelC1 = document.getElementById('tab-label-c1');
        const labelC2 = document.getElementById('tab-label-c2');
        const titleC1 = document.getElementById('title-c1');
        const titleC2 = document.getElementById('title-c2');
        const limitC1 = document.getElementById('limit-c1');
        const limitC2 = document.getElementById('limit-c2');

        window.addEventListener('load', () => {
            initTheme();
            loadProfiles();
            renderCharSelect();
            
            // TENTA IL CARICAMENTO AUTOMATICO DAL SERVER (Per versione Web)
            // Assicurati che il file CSV si chiami ESATTAMENTE così nella stessa cartella/repository
            const csvFileName = "Spellbook - Database Spell.csv"; 
            
            Papa.parse(csvFileName, {
                download: true, // Abilita il download automatico
                header: true,
                skipEmptyLines: true,
                transformHeader: h => h.trim(),
                complete: function(results) {
                    if(results.data && results.data.length > 0) {
                        spellData = results.data.filter(row => row.Name);
                        // Salviamo comunque in cache per performance future
                        localStorage.setItem('dnd_spellbook_db', JSON.stringify(spellData));
                        dbStatus.textContent = "DB: Online";
                        dbStatus.style.color = "var(--free-color)";
                        initFilters();
                        updateUI(); // Aggiorna l'interfaccia con i dati caricati
                        changeCharacter(false);
                    }
                },
                error: function(err) {
                    // Se fallisce (es. sei offline o file non trovato), prova la cache locale
                    console.log("Auto-load fallito, provo cache locale...");
                    loadGlobalData();
                    changeCharacter(false);
                }
            });
        });

        // --- 1. PROFILES & DATA ---
        function loadProfiles() {
            const stored = localStorage.getItem('dnd_profiles_v1');
            if (stored) {
                profiles = JSON.parse(stored);
                // Migration check
                for(let name in profiles) {
                    let p = profiles[name];
                    if(!p.prepared1) {
                        p.prepared1 = p.prepared || []; p.prepared2 = [];
                        p.class1Name = "Classe 1"; p.class2Name = "Classe 2";
                        p.stats1 = p.stats ? {dc: p.stats.dc, atk: p.stats.atk, maxPrep: 0} : {dc:10, atk:0, maxPrep:0};
                        p.stats2 = {dc:10, atk:0, maxPrep:0};
                    }
                    if(!p.free1) { p.free1 = []; p.free2 = []; } 
                    // Migration for V0.14
                    if(p.stats1.maxPrep === undefined) p.stats1.maxPrep = 0;
                    if(p.stats2.maxPrep === undefined) p.stats2.maxPrep = 0;
                }
            } else {
                profiles = { "Avventuriero": JSON.parse(JSON.stringify(defaultProfile)) };
            }
            const lastChar = localStorage.getItem('dnd_last_char');
            if (lastChar && profiles[lastChar]) currentCharName = lastChar;
            else currentCharName = Object.keys(profiles)[0];
        }

        function saveProfiles() {
            localStorage.setItem('dnd_profiles_v1', JSON.stringify(profiles));
            localStorage.setItem('dnd_last_char', currentCharName);
        }

        // Standard CRUD
        function createNewCharacter() {
            const name = prompt("Nome del nuovo personaggio:");
            if (name && !profiles[name]) {
                profiles[name] = JSON.parse(JSON.stringify(defaultProfile));
                currentCharName = name; saveProfiles(); renderCharSelect(); updateUI();
            } else if(profiles[name]) alert("Esiste già!");
        }
        function deleteCharacter() {
            if (Object.keys(profiles).length <= 1) return alert("Minimo 1 PG.");
            if (confirm(`Eliminare ${currentCharName}?`)) {
                delete profiles[currentCharName]; currentCharName = Object.keys(profiles)[0];
                saveProfiles(); renderCharSelect(); updateUI();
            }
        }
        function renameCharacter() {
            const newName = prompt("Nuovo nome:", currentCharName);
            if (newName && newName !== currentCharName && !profiles[newName]) {
                profiles[newName] = profiles[currentCharName]; delete profiles[currentCharName];
                currentCharName = newName; saveProfiles(); renderCharSelect(); updateUI();
            }
        }
        function exportCharacter() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(getCurrentProfile()));
            const a = document.createElement('a'); a.href = dataStr; a.download = currentCharName + ".json";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function importCharacterFile(elem) {
            const file = elem.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(!json.slots) return alert("JSON non valido");
                    let name = file.name.replace('.json','');
                    if(profiles[name] && !confirm("Sovrascrivere?")) name+="(Imp)";
                    profiles[name] = json; currentCharName = name;
                    saveProfiles(); renderCharSelect(); updateUI();
                } catch(err){alert("Err JSON");}
                elem.value='';
            };
            r.readAsText(file);
        }

        function changeCharacter(refresh = true) {
            currentCharName = charSelect.value;
            saveProfiles(); if(refresh) updateUI();
        }
        function renderCharSelect() {
            charSelect.innerHTML = '';
            Object.keys(profiles).forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                if(n===currentCharName) opt.selected=true; charSelect.appendChild(opt);
            });
        }
        function getCurrentProfile() { return profiles[currentCharName]; }
        
        function loadGlobalData() {
            const s = localStorage.getItem('dnd_spellbook_db');
            if(s) { spellData=JSON.parse(s); dbStatus.textContent="DB: OK"; dbStatus.style.color="var(--primary-color)"; initFilters(); }
        }
        fileInput.addEventListener('change', e => {
            if(!e.target.files[0]) return;
            Papa.parse(e.target.files[0], {
                header:true, skipEmptyLines:true, transformHeader:h=>h.trim(),
                complete: r => {
                    spellData = r.data.filter(x=>x.Name);
                    localStorage.setItem('dnd_spellbook_db', JSON.stringify(spellData));
                    dbStatus.textContent="DB: Aggiornato!"; initFilters(); updateUI();
                }
            });
        });

        // --- PREPARED DUAL ---
        function togglePrepared(spellName, checkbox, classIdx) {
            const p = getCurrentProfile();
            const listKey = classIdx === 1 ? 'prepared1' : 'prepared2';
            const set = new Set(p[listKey]);
            
            if(checkbox.checked) set.add(spellName);
            else {
                set.delete(spellName);
                const freeKey = classIdx === 1 ? 'free1' : 'free2';
                const freeSet = new Set(p[freeKey]);
                if(freeSet.has(spellName)) {
                    freeSet.delete(spellName);
                    p[freeKey] = [...freeSet];
                }
            }
            p[listKey] = [...set];
            saveProfiles();
            updateUI(false); 
        }

        function toggleFree(spellName, checkbox, classIdx) {
            const p = getCurrentProfile();
            const freeKey = classIdx === 1 ? 'free1' : 'free2';
            const prepKey = classIdx === 1 ? 'prepared1' : 'prepared2';
            
            const freeSet = new Set(p[freeKey]);
            const prepSet = new Set(p[prepKey]);

            if(checkbox.checked) {
                freeSet.add(spellName);
                prepSet.add(spellName); 
            } else {
                freeSet.delete(spellName);
            }

            p[freeKey] = [...freeSet];
            p[prepKey] = [...prepSet];
            saveProfiles();
            updateUI(false);
        }

        // --- MAGIC RENDER ---
        function renderMagicSection() {
            const p = getCurrentProfile();
            
            document.getElementById('class1-name').value = p.class1Name || "Classe 1";
            document.getElementById('class2-name').value = p.class2Name || "Classe 2";
            document.getElementById('dc1').value = p.stats1.dc;
            document.getElementById('atk1').value = p.stats1.atk;
            document.getElementById('maxPrep1').value = p.stats1.maxPrep || 0; // New input
            document.getElementById('dc2').value = p.stats2.dc;
            document.getElementById('atk2').value = p.stats2.atk;
            document.getElementById('maxPrep2').value = p.stats2.maxPrep || 0; // New input

            // Slots
            const container = document.getElementById('slots-container');
            container.innerHTML = '';
            for (let lvl = 1; lvl <= 10; lvl++) {
                if (!p.slots[lvl]) p.slots[lvl] = { max: 0, usage: [] }; 
                const sData = p.slots[lvl];
                if(!sData.usage) sData.usage = [];
                while(sData.usage.length < sData.max) sData.usage.push(false);
                while(sData.usage.length > sData.max) sData.usage.pop();

                let bubbles = '';
                for(let i=0; i<sData.max; i++) {
                    const cls = sData.usage[i] ? 'used' : '';
                    bubbles += `<div class="slot-bubble ${cls}" onclick="toggleSlot(${lvl}, ${i})"></div>`;
                }
                container.innerHTML += `
                    <div class="slot-row">
                        <div class="slot-label">Livello ${lvl}</div>
                        <div class="slot-config"><input type="number" min="0" value="${sData.max}" onchange="updateMaxSlots(${lvl},this.value)"></div>
                        <div class="slot-bubbles">${bubbles}</div>
                    </div>`;
            }

            // Resources
            if(!p.resources) p.resources = {mana:0, sorcery:0, manaUsed:0, sorceryUsed:0};
            renderRes('mana', p);
            renderRes('sorcery', p);
        }

        function renderRes(type, p) {
            const curr = Math.max(0, p.resources[type] - p.resources[type+'Used']);
            document.getElementById(`display-${type}`).textContent = curr;
            document.getElementById(`${type}-max`).value = p.resources[type];
        }

        function modifyResource(type, amt) {
            const p = getCurrentProfile();
            let used = p.resources[type+'Used'] || 0;
            used -= amt; 
            if(used < 0) used = 0;
            if(used > p.resources[type]) used = p.resources[type];
            p.resources[type+'Used'] = used;
            saveProfiles(); renderMagicSection();
        }
        function updateResourceMax(type, val) {
            const p = getCurrentProfile();
            p.resources[type] = parseInt(val);
            saveProfiles(); renderMagicSection();
        }
        function saveCurrentProfile() {
            const p = getCurrentProfile();
            p.class1Name = document.getElementById('class1-name').value;
            p.class2Name = document.getElementById('class2-name').value;
            p.stats1.dc = document.getElementById('dc1').value;
            p.stats1.atk = document.getElementById('atk1').value;
            p.stats1.maxPrep = document.getElementById('maxPrep1').value; // Save maxPrep
            p.stats2.dc = document.getElementById('dc2').value;
            p.stats2.atk = document.getElementById('atk2').value;
            p.stats2.maxPrep = document.getElementById('maxPrep2').value; // Save maxPrep
            saveProfiles();
            updateTabLabels(p);
        }
        function updateTabLabels(p) {
            const name1 = p.class1Name || "Classe 1";
            const name2 = p.class2Name || "Classe 2";
            labelC1.textContent = name1;
            labelC2.textContent = name2;
            titleC1.textContent = name1;
            titleC2.textContent = name2;
        }

        // Slots
        function updateMaxSlots(lvl, val) {
            const p = getCurrentProfile();
            p.slots[lvl].max = parseInt(val);
            saveProfiles(); renderMagicSection();
        }
        function toggleSlot(lvl, idx) {
            const p = getCurrentProfile();
            p.slots[lvl].usage[idx] = !p.slots[lvl].usage[idx];
            saveProfiles(); renderMagicSection();
        }
        function longRest() {
            const p = getCurrentProfile();
            for(let l=1; l<=10; l++) if(p.slots[l]) p.slots[l].usage = p.slots[l].usage.map(()=>false);
            p.resources.manaUsed = 0;
            p.resources.sorceryUsed = 0;
            saveProfiles(); renderMagicSection(); alert("Riposo Lungo Completato!");
        }

        // --- RENDER MAIN ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.section-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            
            const f = document.getElementById('filter-container');
            if(tab === 'magic') f.style.display='none'; else f.style.display='grid';
            updateUI();
        }

        function updateUI(full = true) {
            const p = getCurrentProfile();
            
            // Counts
            const count1 = (p.prepared1 ? p.prepared1.length : 0) - (p.free1 ? p.free1.length : 0);
            const count2 = (p.prepared2 ? p.prepared2.length : 0) - (p.free2 ? p.free2.length : 0);
            const displayCount1 = Math.max(0, count1);
            const displayCount2 = Math.max(0, count2);
            
            badgeC1.textContent = displayCount1;
            badgeC2.textContent = displayCount2;
            
            // --- LIMIT WARNINGS ---
            const max1 = parseInt(p.stats1.maxPrep) || 0;
            const max2 = parseInt(p.stats2.maxPrep) || 0;

            // Warning Logic: If max > 0 and count > max, Trigger Warning
            const warn1 = (max1 > 0 && displayCount1 > max1);
            const warn2 = (max2 > 0 && displayCount2 > max2);

            // Update Badge Styles
            if(warn1) badgeC1.classList.add('warning'); else badgeC1.classList.remove('warning');
            if(warn2) badgeC2.classList.add('warning'); else badgeC2.classList.remove('warning');

            // Update Header Limits Text
            const limitText1 = `(${displayCount1} / ${max1})`;
            limitC1.textContent = limitText1 + (warn1 ? " (OVER LIMIT!)" : "");
            if(warn1) limitC1.className = "over-limit-text"; else limitC1.className = "";

            const limitText2 = `(${displayCount2} / ${max2})`;
            limitC2.textContent = limitText2 + (warn2 ? " (OVER LIMIT!)" : "");
            if(warn2) limitC2.className = "over-limit-text"; else limitC2.className = "";

            updateTabLabels(p);

            if(currentTab === 'magic') renderMagicSection();
            else if(full) renderSpellsList();
        }

        function renderSpellsList() {
            const p = getCurrentProfile();
            
            const containerGrim = document.getElementById('spell-container-grimorio');
            const containerC1 = document.getElementById('spell-container-c1');
            const containerC2 = document.getElementById('spell-container-c2');
            
            if(containerGrim) containerGrim.innerHTML = '';
            if(containerC1) containerC1.innerHTML = '';
            if(containerC2) containerC2.innerHTML = '';

            if (spellData.length === 0) return;

            const set1 = new Set(p.prepared1 || []);
            const set2 = new Set(p.prepared2 || []);
            const free1 = new Set(p.free1 || []);
            const free2 = new Set(p.free2 || []);

            let filtered = spellData.filter(s => {
                if(currentTab === 'class1') return set1.has(s.Name);
                if(currentTab === 'class2') return set2.has(s.Name);
                
                const txt = document.getElementById('search-input').value.toLowerCase();
                if (txt && !s.Name.toLowerCase().includes(txt) && !s.Effect.toLowerCase().includes(txt)) return false;
                
                const cls = document.getElementById('class-select').value;
                if (cls !== 'all' && s[cls] !== "TRUE" && s[cls] !== true && s[cls] !== "True") return false;
                
                const lvl = document.getElementById('level-select').value;
                if (lvl !== 'all' && parseInt(s.Level) !== parseInt(lvl)) return false;
                
                const sch = document.getElementById('school-select').value;
                if (sch !== 'all' && s.School !== sch) return false;
                
                return true;
            });

            filtered.sort((a, b) => (parseInt(a.Level)||0) - (parseInt(b.Level)||0) || a.Name.localeCompare(b.Name));

            if(filtered.length === 0 && currentTab === 'grimorio') {
                containerGrim.innerHTML = '<div style="text-align:center;">Nessun risultato.</div>'; return;
            }

            let targetContainer = containerGrim;
            if(currentTab === 'class1') targetContainer = containerC1;
            if(currentTab === 'class2') targetContainer = containerC2;

            filtered.forEach(spell => {
                const isP1 = set1.has(spell.Name);
                const isP2 = set2.has(spell.Name);
                const isF1 = free1.has(spell.Name);
                const isF2 = free2.has(spell.Name);
                renderCard(spell, targetContainer, isP1, isP2, isF1, isF2);
            });
        }

        function renderCard(spell, container, checked1, checked2, free1, free2) {
            const p = getCurrentProfile();
            const levelTxt = parseInt(spell.Level) === 0 ? "Trucchetto" : `Liv. ${spell.Level}`;
            const isConc = spell.Duration && spell.Duration.toLowerCase().includes('concentration');
            const isRitual = spell.Duration && spell.Duration.toLowerCase().includes('ritual');

            const card = document.createElement('div');
            let classes = 'spell-card';
            
            if(currentTab === 'class1') {
                classes += ' is-prepared-1';
                if(free1) classes += ' is-free';
            }
            else if(currentTab === 'class2') {
                classes += ' is-prepared-2';
                if(free2) classes += ' is-free';
            }
            else {
                if(checked1) classes += ' is-prepared-1';
                if(checked2) classes += ' is-prepared-2';
            }
            card.className = classes;

            const t1 = p.class1Name || "Classe 1";
            const t2 = p.class2Name || "Classe 2";

            let checkboxHtml = '';
            
            if(currentTab === 'grimorio') {
                 checkboxHtml = `
                    <input type="checkbox" class="prep-checkbox class1" title="Prepara per ${t1}" 
                        ${checked1 ? 'checked' : ''} onchange="togglePrepared('${spell.Name.replace(/'/g, "\\'")}', this, 1)">
                    <input type="checkbox" class="prep-checkbox class2" title="Prepara per ${t2}"
                        ${checked2 ? 'checked' : ''} onchange="togglePrepared('${spell.Name.replace(/'/g, "\\'")}', this, 2)">
                 `;
            } else if (currentTab === 'class1') {
                checkboxHtml = `
                    <input type="checkbox" class="prep-checkbox class1" title="Prepara" 
                        ${checked1 ? 'checked' : ''} onchange="togglePrepared('${spell.Name.replace(/'/g, "\\'")}', this, 1)">
                    <label class="free-label">
                        <input type="checkbox" class="prep-checkbox free-check" title="Segna come Gratis" 
                        ${free1 ? 'checked' : ''} onchange="toggleFree('${spell.Name.replace(/'/g, "\\'")}', this, 1)"> (Free)
                    </label>
                `;
            } else if (currentTab === 'class2') {
                checkboxHtml = `
                    <input type="checkbox" class="prep-checkbox class2" title="Prepara"
                        ${checked2 ? 'checked' : ''} onchange="togglePrepared('${spell.Name.replace(/'/g, "\\'")}', this, 2)">
                    <label class="free-label">
                        <input type="checkbox" class="prep-checkbox free-check" title="Segna come Gratis" 
                        ${free2 ? 'checked' : ''} onchange="toggleFree('${spell.Name.replace(/'/g, "\\'")}', this, 2)"> (Free)
                    </label>
                `;
            }

            card.innerHTML = `
                <div class="spell-header">
                    <div class="prep-check-group" onclick="event.stopPropagation()">
                        ${checkboxHtml}
                    </div>
                    <div style="flex-grow:1;" onclick="this.closest('.spell-card').classList.toggle('active')">
                        <div class="spell-title">${spell.Name} 
                            <span class="icon-tag ${isConc?'icon-conc':''}" style="display:${isConc?'inline':'none'}">C</span>
                            <span class="icon-tag ${isRitual?'icon-rit':''}" style="display:${isRitual?'inline':'none'}">R</span>
                            <span class="icon-tag icon-free" style="display:${(free1 && currentTab!=='class2') || (free2 && currentTab!=='class1') ? 'inline':'none'}">FREE</span>
                        </div>
                        <div class="spell-meta-short">${spell.School} • ${levelTxt}</div>
                    </div>
                </div>
                <div class="spell-details">
                    <div class="stats-grid">
                        <div class="stat-box"><strong>Tempo</strong>${spell['Casting Time']||'-'}</div>
                        <div class="stat-box"><strong>Gittata</strong>${spell.Range||'-'}</div>
                        <div class="stat-box"><strong>Comp.</strong>${spell.Mats||'-'}</div>
                        <div class="stat-box"><strong>Durata</strong>${spell.Duration||'-'}</div>
                    </div>
                    <div class="spell-desc">${spell.Effect||''}</div>
                    ${spell['At High Level'] ? `<div class="higher-levels">${spell['At High Level']}</div>` : ''}
                </div>
            `;
            container.appendChild(card);
        }

        document.getElementById('search-input').addEventListener('input', () => updateUI(true));
        document.getElementById('class-select').addEventListener('change', () => updateUI(true));
        document.getElementById('level-select').addEventListener('change', () => updateUI(true));
        document.getElementById('school-select').addEventListener('change', () => updateUI(true));

        function initFilters() {
            const classSel = document.getElementById('class-select');
            const schoolSel = document.getElementById('school-select');
            const currClass = classSel.value;
            
            classSel.innerHTML = '<option value="all">Tutte le Classi</option>';
            const cols = ['Arcane Trickster', 'Bard', 'Cleric', 'Druid', 'Eldritch Knight', 'Paladin', 'Ranger', 'Sorcerer', 'Warlock', 'Wizard', 'Artificier', 'Psion'];
            cols.forEach(c => {
                if(spellData.length && spellData[0].hasOwnProperty(c)) {
                    classSel.innerHTML += `<option value="${c}">${c}</option>`;
                }
            });
            classSel.value = currClass; 

            const schools = [...new Set(spellData.map(s => s.School))].filter(s => s).sort();
            schoolSel.innerHTML = '<option value="all">Tutte le Scuole</option>' + schools.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function toggleTheme() {
            const root = document.documentElement;
            const newTheme = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('dnd_theme', newTheme);
        }
        function initTheme() {
            const t = localStorage.getItem('dnd_theme') || 'light';
            document.documentElement.setAttribute('data-theme', t);
        }
    </script>
</body>
</html>